---
import { Image } from "astro:assets";
import appScreen1 from "../assets/pictures/app-morning.png";
import appScreen2 from "../assets/pictures/app-environment.png";
import appScreen3 from "../assets/pictures/app-insight.png";

const appFeatures = [
    {
        id: "morning",
        title: "Morning Check-in",
        description:
            "Stop analyzing graphs the moment you open your eyes. Just tap an emoji to log how you feel. It takes 3 seconds and prioritizes your subjective experience over raw algorithms.",
        image: appScreen1,
    },
    {
        id: "environment",
        title: "Connect the dots",
        description:
            "Amber correlates your mood with invisible environmental factors. Discover if a spike in CO2, low humidity, or temperature shifts impacted your deep sleep.",
        image: appScreen2,
    },
    {
        id: "rhythms",
        title: "Weekly Rhythms",
        description:
            "Zoom out when youâ€™re ready. View long-term trends in sleep consistency and room health in a calm, hidden dashboard designed for reflection, not judgment.",
        image: appScreen3,
    },
];
---

<section class="relative py-9xl md:py-4xl" id="app-sticky-section">
    <div class="relative" style={`height: ${appFeatures.length * 100}vh;`}>
        <div
            class="sticky top-0 md:py-5xl w-full flex items-center overflow-hidden"
        >
            <div
                class="px-container w-full flex flex-col md:flex-row justify-between gap-xl md:gap-0"
            >
                <div
                    class="md:w-4/12 flex flex-col md:h-2xl justify-between gap-xl md:gap-0"
                >
                    <h2 class="title-2xl text-text-primary">
                        Your sleep rhythm, revealed
                    </h2>

                    <div class="relative h-48">
                        {
                            appFeatures.map((feature, index) => (
                                <div
                                    class="app-description absolute inset-0 flex flex-col gap-xs opacity-0 pointer-events-none transition-opacity duration-300"
                                    data-index={index}
                                >
                                    <h3 class="title-lg text-text-primary">
                                        {feature.title}
                                    </h3>
                                    <p class="body-md text-text-primary">
                                        {feature.description}
                                    </p>
                                </div>
                            ))
                        }
                    </div>
                </div>

                <div
                    class="md:w-7/12 relative h-md md:h-2xl w-full rounded-medium overflow-hidden shadow-xl bg-surface-primary"
                >
                    {
                        appFeatures.map((feature, index) => (
                            <div
                                class="app-layer absolute inset-0 w-full h-full will-change-[clip-path]"
                                data-index={index}
                                style={`z-index: ${appFeatures.length - index};`}
                            >
                                <Image
                                    src={feature.image}
                                    alt={feature.title}
                                    class="w-full h-full object-cover"
                                    loading="lazy"
                                />
                            </div>
                        ))
                    }
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .app-description[data-active="true"] {
        opacity: 1;
        pointer-events: auto;
    }
</style>

<script>
    function initAppAnimation() {
        // Use Type Casting to tell TypeScript this is an HTMLElement
        const section = document.getElementById("app-sticky-section") as HTMLElement;
        
        // If it doesn't exist, stop immediately
        if (!section) return;

        const layers = section.querySelectorAll(".app-layer");
        const texts = section.querySelectorAll(".app-description");
        const totalFeatures = layers.length;

        function updateAnimation() {
            // Re-verify section exists to satisfy TypeScript's strict null checking
            if (!section) return;

            const sectionRect = section.getBoundingClientRect();
            const windowHeight = window.innerHeight;
            const sectionHeight = section.offsetHeight;

            const maxScroll = sectionHeight - windowHeight;
            // Ensure we don't divide by zero if section isn't tall yet
            if (maxScroll <= 0) return;

            const scrollOffset = -sectionRect.top;
            const progress = Math.max(0, Math.min(1, scrollOffset / maxScroll));

            const activeIndex = Math.round(progress * (totalFeatures - 1));

            layers.forEach((layer, i) => {
                const layerElement = layer as HTMLElement;
                const textElement = texts[i] as HTMLElement;

                if (i < totalFeatures - 1) {
                    const start = i / (totalFeatures - 1);
                    const end = (i + 1) / (totalFeatures - 1);

                    let layerProgress = (progress - start) / (end - start);
                    layerProgress = Math.max(0, Math.min(1, layerProgress));

                    layerElement.style.clipPath = `inset(0% 0% ${layerProgress * 100}% 0%)`;
                } else {
                    layerElement.style.clipPath = `inset(0% 0% 0% 0%)`;
                }

                if (textElement) {
                    textElement.setAttribute(
                        "data-active",
                        i === activeIndex ? "true" : "false",
                    );
                }
            });
        }

        window.addEventListener(
            "scroll",
            () => {
                window.requestAnimationFrame(updateAnimation);
            },
            { passive: true },
        );

        window.addEventListener("resize", updateAnimation);
        updateAnimation();
    }

    initAppAnimation();
    document.addEventListener("astro:after-swap", initAppAnimation);
</script>